<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <title>ç®€æ˜“ ChatGPT èŠå¤©</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Tailwind CSS CDNï¼Œç”¨æ¥å¿«é€Ÿå†™æ¼‚äº®æ ·å¼ -->
    <script src="./tailwind.js"></script>
    <!-- Vue 3 CDNï¼Œç”¨æ¥ç®¡ç†èŠå¤©çŠ¶æ€å’Œäº¤äº’ -->
    <script src="./vue3.js"></script>
</head>

<body class="min-h-screen bg-slate-50 text-slate-800 antialiased font-sans">
    <div id="app" class="h-screen flex justify-center overflow-hidden bg-slate-50">
        <div
            class="flex w-full max-w-6xl bg-white shadow-2xl overflow-hidden h-full sm:h-[95vh] sm:my-auto sm:rounded-2xl border border-slate-200/60 ring-1 ring-slate-900/5">
            <!-- å·¦ä¾§èŠå¤©åˆ—è¡¨ / è”ç³»äºº -->
            <aside
                class="w-64 border-r border-slate-200/60 bg-slate-50/80 backdrop-blur-xl flex flex-col z-10 shrink-0">
                <div class="px-4 py-4 border-b border-slate-200/60">
                    <div class="flex items-center justify-between mb-3">
                        <div class="text-xs font-bold text-slate-400 uppercase tracking-wider">Messages</div>
                    </div>
                    <button @click="createNewChat" :disabled="hasEmptyChat"
                        class="w-full group inline-flex items-center justify-center gap-2 rounded-xl px-4 py-2.5 text-sm font-semibold text-white shadow-lg shadow-indigo-500/20 transition-all duration-200 ease-in-out"
                        :class="hasEmptyChat ? 'bg-slate-300 cursor-not-allowed' : 'bg-indigo-600 hover:bg-indigo-700 hover:shadow-indigo-500/30 hover:-translate-y-0.5'"
                        :title="hasEmptyChat ? 'å½“å‰å­˜åœ¨ç©ºä¼šè¯ï¼Œæ— æ³•åˆ›å»ºæ–°ä¼šè¯' : 'åˆ›å»ºæ–°ä¼šè¯'">
                        <svg class="w-4 h-4 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4">
                            </path>
                        </svg>
                        æ–°å»ºå¯¹è¯
                    </button>
                </div>
                <!-- åˆ—è¡¨åŒºåŸŸ -->
                <div class="flex-1 overflow-y-auto py-3 px-3 space-y-1 custom-scrollbar">
                    <div v-for="chat in chats" :key="chat.id" @click="setActiveChat(chat.id)"
                        class="relative w-full px-3 py-3 text-left flex flex-col gap-1 rounded-xl cursor-pointer border transition-all duration-200 group"
                        :class="chat.id === activeChatId
                                ? 'bg-white border-slate-200/60 shadow-sm ring-1 ring-slate-900/5'
                                : 'bg-transparent border-transparent hover:bg-slate-200/50 hover:border-slate-200/30'">

                        <div class="flex items-start justify-between gap-2">
                            <!-- æ ‡é¢˜ -->
                            <span class="font-medium truncate flex-1 text-sm"
                                :class="chat.id === activeChatId ? 'text-slate-800' : 'text-slate-600 group-hover:text-slate-900'">
                                {{ chat.name }}
                            </span>

                            <!-- çŠ¶æ€ç‚¹ -->
                            <span class="mt-1.5 flex-shrink-0 w-2 h-2 rounded-full transition-colors"
                                :class="isChatEmpty(chat) ? 'border border-slate-300' : 'bg-green-500 shadow-sm shadow-green-500/30'"
                                :title="isChatEmpty(chat) ? 'ç©ºä¼šè¯' : 'æœ‰æ¶ˆæ¯'"></span>
                        </div>

                        <div class="flex items-center justify-between text-xs mt-0.5">
                            <span class="truncate pr-2 transition-colors"
                                :class="chat.id === activeChatId ? 'text-slate-400' : 'text-slate-400/80 group-hover:text-slate-500'">
                                {{ chat.preview || 'æš‚æ— æ¶ˆæ¯' }}
                            </span>

                            <!-- åˆ é™¤æŒ‰é’® (hover show) -->
                            <button @click.stop="deleteChat(chat.id)"
                                class="opacity-0 group-hover:opacity-100 p-1 rounded-md text-slate-400 hover:text-red-500 hover:bg-red-50 transition-all transform scale-90 hover:scale-100"
                                title="åˆ é™¤ä¼šè¯">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                    </path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- åˆ†é¡µåº•éƒ¨ -->
                <div
                    class="px-4 py-3 border-t border-slate-200/60 bg-slate-50/50 backdrop-blur flex items-center justify-between text-xs text-slate-500">
                    <button @click="prevPage" :disabled="page <= 1"
                        class="p-1 hover:bg-white hover:shadow-sm rounded-md hover:text-indigo-600 disabled:opacity-30 disabled:hover:bg-transparent disabled:hover:text-slate-500 cursor-pointer disabled:cursor-not-allowed transition-all">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7">
                            </path>
                        </svg>
                    </button>
                    <span class="font-semibold tabular-nums text-slate-400">{{ page }} / {{ Math.max(1, Math.ceil(total
                        / pageSize)) }}</span>
                    <button @click="nextPage" :disabled="page * pageSize >= total"
                        class="p-1 hover:bg-white hover:shadow-sm rounded-md hover:text-indigo-600 disabled:opacity-30 disabled:hover:bg-transparent disabled:hover:text-slate-500 cursor-pointer disabled:cursor-not-allowed transition-all">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7">
                            </path>
                        </svg>
                    </button>
                </div>
            </aside>

            <!-- å³ä¾§ä¸»èŠå¤©åŒºåŸŸ -->
            <div class="flex flex-col flex-1 h-full">
                <!-- é¡¶éƒ¨æ  -->
                <header
                    class="flex items-center justify-between px-6 py-4 border-b border-slate-200/60 bg-white/80 backdrop-blur-xl z-10">
                    <div>
                        <h1 class="text-base font-bold text-slate-800 flex items-center gap-2">
                            {{ activeChat?.name || 'æˆ‘çš„ AI åŠ©æ‰‹' }}
                            <span v-if="activeChat?.threadId"
                                class="px-1.5 py-0.5 rounded-md bg-slate-100 text-[10px] font-normal text-slate-500 font-mono tracking-tight">{{
                                activeChat.threadId.slice(0, 8) }}</span>
                        </h1>
                        <p class="mt-0.5 text-[11px] text-slate-400 font-medium">
                            <span class="w-1.5 h-1.5 rounded-full bg-green-500 inline-block mr-1"></span>
                            {{ currentUserId || 'æœªè®¾ç½®' }}
                        </p>
                    </div>
                    <button @click="openUserModal"
                        class="inline-flex items-center rounded-lg border border-slate-200/60 bg-white px-3 py-1.5 text-xs font-medium text-slate-600 shadow-sm hover:bg-slate-50 hover:text-slate-900 transition-all">
                        åˆ‡æ¢ç”¨æˆ·
                    </button>
                </header>

                <!-- èŠå¤©å†…å®¹ -->
                <main ref="chatMain"
                    class="flex-1 overflow-y-auto px-6 py-6 space-y-6 bg-slate-50 custom-scrollbar scroll-smooth">
                    <template v-if="messages.length">
                        <div v-for="(m, index) in messages" :key="`msg-${index}-${m.content?.slice(0, 10)}`"
                            class="flex gap-4 group" :class="m.role === 'user' ? 'justify-end' : 'justify-start'">

                            <!-- AI æ¶ˆæ¯ï¼šå¤´åƒåœ¨å·¦ -->
                            <template v-if="m.role === 'assistant'">
                                <div class="flex gap-4 max-w-[85%]">
                                    <div
                                        class="flex h-9 w-9 items-center justify-center rounded-full bg-white border border-slate-100 shadow-sm text-lg flex-shrink-0 mt-0.5">
                                        ğŸ¤–
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <div class="text-[11px] font-medium text-slate-400 mb-1 ml-1">AI Assistant</div>
                                        <div
                                            class="rounded-2xl rounded-tl-sm bg-white border border-slate-200/60 shadow-sm px-4 py-3 text-sm text-slate-700 leading-relaxed whitespace-pre-wrap break-words">
                                            <!-- æ˜¾ç¤ºæ¶ˆæ¯å†…å®¹ -->
                                            <template v-if="m.displayedContent || m.content">
                                                {{ m.displayedContent || m.content }}
                                                <!-- å›å¤è¿˜åœ¨è¿›è¡Œä¸­æ—¶ï¼Œæ˜¾ç¤ºä¸€ä¸ªè·³åŠ¨çš„å°å…‰æ ‡ -->
                                                <span v-if="m.isThinking"
                                                    class="inline-block w-1.5 h-3.5 ml-0.5 align-middle animate-pulse bg-indigo-400 rounded-sm">&nbsp;</span>
                                            </template>

                                            <!-- è¿˜æ²¡æœ‰å†…å®¹ï¼Œä½†å¤„äºæ€è€ƒä¸­ï¼šæ˜¾ç¤ºä¸‰ç‚¹åŠ è½½åŠ¨ç”» -->
                                            <template v-else-if="m.isThinking">
                                                <div class="flex items-center gap-1.5 py-1">
                                                    <span
                                                        class="h-1.5 w-1.5 rounded-full bg-slate-400 animate-bounce"></span>
                                                    <span
                                                        class="h-1.5 w-1.5 rounded-full bg-slate-400 animate-bounce [animation-delay:0.15s]"></span>
                                                    <span
                                                        class="h-1.5 w-1.5 rounded-full bg-slate-400 animate-bounce [animation-delay:0.3s]"></span>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                            </template>

                            <!-- ç”¨æˆ·æ¶ˆæ¯ï¼šå¤´åƒåœ¨å³ -->
                            <template v-else>
                                <div class="flex gap-4 max-w-[85%] flex-row-reverse">
                                    <div
                                        class="flex h-9 w-9 items-center justify-center rounded-full bg-indigo-600 text-white text-sm font-semibold flex-shrink-0 mt-0.5 shadow-md shadow-indigo-500/20">
                                        Me
                                    </div>
                                    <div class="flex-1 min-w-0 text-right">
                                        <div class="text-[11px] font-medium text-slate-400 mb-1 mr-1">You</div>
                                        <div
                                            class="inline-block rounded-2xl rounded-tr-sm bg-gradient-to-br from-indigo-600 to-violet-600 px-4 py-3 text-sm leading-relaxed text-white shadow-md shadow-indigo-500/10 whitespace-pre-wrap break-words text-left">
                                            {{ m.content }}
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>

                    <!-- å½“å‰ä¼šè¯æ— æ¶ˆæ¯æ—¶çš„å ä½æç¤º -->
                    <template v-else>
                        <div class="h-full flex flex-col items-center justify-center text-center space-y-6">
                            <div class="grid place-items-center w-16 h-16 rounded-full bg-zinc-100 text-zinc-400 mb-2">
                                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                        d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z">
                                    </path>
                                </svg>
                            </div>
                            <div class="space-y-1">
                                <p class="text-sm font-medium text-zinc-600">å¼€å§‹æ–°çš„å¯¹è¯</p>
                                <p class="text-xs text-zinc-400">åœ¨ä¸‹æ–¹è¾“å…¥ä½ çš„é—®é¢˜ï¼Œå¼€å¯ä¸€æ®µç²¾å½©çš„å¯¹è¯</p>
                            </div>

                            <div class="flex items-center gap-3 text-[10px] text-zinc-300 w-full max-w-[240px]">
                                <span class="h-[1px] bg-zinc-200 flex-1"></span>
                                <span>OR</span>
                                <span class="h-[1px] bg-zinc-200 flex-1"></span>
                            </div>

                            <button @click="sayHello"
                                class="group relative flex items-center justify-center gap-2 px-6 py-2.5 bg-white border border-zinc-200 rounded-full shadow-sm hover:shadow-md hover:border-blue-200 hover:bg-blue-50/50 transition-all duration-300 cursor-pointer">
                                <span
                                    class="text-lg group-hover:rotate-12 transition-transform duration-300 origin-bottom-right">ğŸ‘‹</span>
                                <span
                                    class="text-xs font-medium text-zinc-500 group-hover:text-blue-600 transition-colors">å¿«é€Ÿæ‰“ä¸ªæ‹›å‘¼</span>
                            </button>
                        </div>
                    </template>
                </main>

                <!-- è¾“å…¥åŒºåŸŸ -->
                <section class="border-t border-slate-200/60 bg-white/80 backdrop-blur-xl px-6 pt-4 pb-6 z-10">
                    <div class="flex items-end gap-3 max-w-4xl mx-auto w-full">
                        <div
                            class="flex-1 rounded-2xl border border-slate-200/80 bg-slate-50 px-4 py-3 shadow-sm focus-within:ring-2 focus-within:ring-indigo-500/20 focus-within:border-indigo-500 focus-within:bg-white transition-all duration-200">
                            <textarea v-model="input" @keydown.enter.exact.prevent="handleEnter"
                                @keydown.enter.shift.exact.stop rows="1" placeholder="è¾“å…¥æ¶ˆæ¯..."
                                class="block w-full resize-none border-0 bg-transparent p-0 text-sm text-slate-800 placeholder:text-slate-400 focus:outline-none focus:ring-0 max-h-32"></textarea>
                        </div>
                        <button :disabled="!input.trim() || isThinking" @click="send"
                            class="group inline-flex items-center justify-center h-[46px] w-[46px] rounded-full bg-indigo-600 text-white shadow-lg shadow-indigo-500/30 transition-all hover:bg-indigo-700 hover:scale-105 active:scale-95 disabled:bg-slate-300 disabled:shadow-none disabled:cursor-not-allowed disabled:scale-100">
                            <span v-if="!isThinking">
                                <svg class="w-5 h-5 translate-x-0.5" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                                </svg>
                            </span>
                            <span v-else class="inline-flex items-center justify-center">
                                <span
                                    class="h-4 w-4 animate-spin rounded-full border-[2px] border-white/40 border-t-white"></span>
                            </span>
                        </button>
                    </div>
                </section>
            </div>
        </div>

        <!-- ç”¨æˆ·åè¾“å…¥å¼¹çª—ï¼ˆå¿…é¡»æ”¾åœ¨ #app å†…éƒ¨ï¼Œv-if æ‰ç”Ÿæ•ˆï¼‰ -->
        <!-- ç”¨æˆ·åè¾“å…¥å¼¹çª—ï¼ˆå¿…é¡»æ”¾åœ¨ #app å†…éƒ¨ï¼Œv-if æ‰ç”Ÿæ•ˆï¼‰ -->
        <div v-if="isUserModalOpen"
            class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/40 backdrop-blur-sm">
            <div
                class="w-[320px] rounded-2xl bg-white shadow-2xl shadow-indigo-500/20 border border-slate-200/60 ring-1 ring-slate-900/5 p-6 animate-in fade-in zoom-in duration-200">
                <div class="text-base font-bold text-slate-800 mb-1">è®¾ç½®ä½ çš„åå­—</div>
                <div class="text-xs text-slate-500 mb-4 leading-relaxed">è¯·å¡«å†™ä¸€ä¸ªå”¯ä¸€çš„ç”¨æˆ·å (userId)ï¼Œç³»ç»Ÿå°†æ ¹æ®è¯¥ ID ä¿å­˜ä½ çš„å¯¹è¯å†å²ã€‚</div>
                <input v-model="tempUserInput" type="text" placeholder="ä¾‹å¦‚: User_888"
                    class="w-full rounded-xl border border-slate-200 bg-slate-50 px-4 py-2.5 text-sm text-slate-800 placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all" />
                <div class="mt-6 flex justify-end gap-3">
                    <button @click="closeUserModal"
                        class="px-4 py-2 text-xs font-medium rounded-lg border border-slate-200 text-slate-600 hover:bg-slate-50 hover:text-slate-900 transition-colors">å–æ¶ˆ
                    </button>
                    <button @click="confirmUserId"
                        class="px-4 py-2 text-xs font-medium rounded-lg bg-indigo-600 text-white shadow-md shadow-indigo-500/20 hover:bg-indigo-700 hover:shadow-indigo-500/30 hover:-translate-y-0.5 transition-all">ç¡®å®š
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, reactive, nextTick, onMounted } = Vue;

        // ========== é…ç½®å¸¸é‡ ==========
        const CONFIG = {
            API_URL: "http://127.0.0.1:8000/api/chat/stream",
            THREADS_API_URL: "http://127.0.0.1:8000/api/threads",
            TYPEWRITER_SPEED: 20, // æ‰“å­—æœºæ•ˆæœé€Ÿåº¦ï¼ˆæ¯«ç§’/å­—ç¬¦ï¼‰
            SCROLL_DEBOUNCE: 100, // æ»šåŠ¨é˜²æŠ–æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
            TYPEWRITER_CLEANUP_DELAY: 100 // æ‰“å­—æœºæ¸…ç†å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰
        };

        // é»˜è®¤æ¬¢è¿æ¶ˆæ¯ï¼ˆæ‰€æœ‰ä¼šè¯çš„ç¬¬ä¸€æ¡ AI æ¶ˆæ¯ï¼‰
        // const DEFAULT_WELCOME_MESSAGE = {
        //     role: "assistant",
        //     content: "ä½ å¥½ï¼Œæˆ‘æ˜¯ä½ çš„ AI åŠ©æ‰‹ï¼Œå¯ä»¥åƒ ChatGPT ä¸€æ ·å’Œä½ èŠå¤©ã€‚\nä½ å¯ä»¥åœ¨ä¸‹æ–¹è¾“å…¥é—®é¢˜ï¼Œç„¶åæŒ‰ã€Œå›è½¦ã€æˆ–ç‚¹å‡»ã€Œå‘é€ã€ã€‚",
        //     displayedContent: "ä½ å¥½ï¼Œæˆ‘æ˜¯ä½ çš„ AI åŠ©æ‰‹ï¼Œå¯ä»¥åƒ ChatGPT ä¸€æ ·å’Œä½ èŠå¤©ã€‚\nä½ å¯ä»¥åœ¨ä¸‹æ–¹è¾“å…¥é—®é¢˜ï¼Œç„¶åæŒ‰ã€Œå›è½¦ã€æˆ–ç‚¹å‡»ã€Œå‘é€ã€ã€‚"
        // };

        createApp({
            setup() {
                // ========== å“åº”å¼çŠ¶æ€ ==========
                const chats = ref([]);  // ä¼šè¯åˆ—è¡¨å°†ä»åç«¯åŠ è½½
                const activeChatId = ref("");
                const input = ref("");
                const chatMain = ref(null);
                const typewriterTimers = new Map(); // å­˜å‚¨æ¯ä¸ªæ¶ˆæ¯çš„æ‰“å­—æœºå®šæ—¶å™¨
                let scrollTimer = null; // æ»šåŠ¨é˜²æŠ–å®šæ—¶å™¨
                const currentUserId = ref("");
                const isUserModalOpen = ref(false);
                const tempUserInput = ref("");

                // åˆ†é¡µçŠ¶æ€
                const page = ref(1);
                const pageSize = ref(20);
                const total = ref(0);

                // ========== è®¡ç®—å±æ€§ ==========
                const activeChat = computed(() =>
                    chats.value.find(c => c.id === activeChatId.value) || null
                );
                const messages = computed(() =>
                    activeChat.value ? activeChat.value.messages : []
                );
                const isThinking = computed(() => {
                    if (!activeChat.value) return false;
                    return activeChat.value.messages.some(m => m.role === "assistant" && m.isThinking);
                });

                // æ£€æŸ¥æ˜¯å¦å­˜åœ¨ç©ºä¼šè¯ï¼ˆæ²¡æœ‰æ¶ˆæ¯çš„ä¼šè¯ï¼‰
                // ä¼˜å…ˆä½¿ç”¨åç«¯è¿”å›çš„ is_empty çŠ¶æ€ï¼Œå¦åˆ™é€šè¿‡ messages.length åˆ¤æ–­
                const hasEmptyChat = computed(() => {
                    return chats.value.some(chat => {
                        // å¦‚æœæœ‰ isEmptyFromServer å­—æ®µï¼Œä¼˜å…ˆä½¿ç”¨å®ƒ
                        if (chat.isEmptyFromServer !== undefined) {
                            return chat.isEmptyFromServer;
                        }
                        return chat.messages.length === 0;
                    });
                });

                // åˆ¤æ–­å•ä¸ªä¼šè¯æ˜¯å¦ä¸ºç©º
                function isChatEmpty(chat) {
                    if (chat.isEmptyFromServer !== undefined) {
                        return chat.isEmptyFromServer;
                    }
                    return chat.messages.length === 0;
                }

                // ========== ç”¨æˆ·å / æœ¬åœ°å­˜å‚¨ ==========
                function updateAllChatUserIds(uid) {
                    chats.value.forEach(c => {
                        c.userId = uid || "";
                    });
                }

                function openUserModal() {
                    tempUserInput.value = currentUserId.value;
                    isUserModalOpen.value = true;
                }

                function closeUserModal() {
                    // å¦‚æœå°šæœªè®¾ç½®åå­—ï¼Œåˆ™ä¸å…è®¸å…³é—­å¹¶æç¤º
                    if (!currentUserId.value.trim()) {
                        alert("è¯·å…ˆè¾“å…¥åå­—å¹¶ç‚¹å‡»ç¡®å®šï¼Œæ‰èƒ½å…³é—­å¼¹çª—å“¦ï¼");
                        return;
                    }
                    isUserModalOpen.value = false;
                }

                async function confirmUserId() {
                    const val = tempUserInput.value.trim();
                    if (!val) {
                        alert("è¯·è¾“å…¥ä½ çš„åå­—ï¼Œç”¨ä½œ userId");
                        return;
                    }
                    currentUserId.value = val;
                    localStorage.setItem("chatUserId", val);
                    updateAllChatUserIds(val);
                    isUserModalOpen.value = false;
                    // åŠ è½½è¯¥ç”¨æˆ·çš„å†å²ä¼šè¯
                    await loadThreads();
                }

                function ensureUserId() {
                    if (currentUserId.value) return true;
                    openUserModal();
                    return false;
                }

                // ========== å·¥å…·å‡½æ•° ==========
                /**
                 * æ»šåŠ¨åˆ°åº•éƒ¨
                 * @param {string} behavior - æ»šåŠ¨è¡Œä¸ºï¼š'auto' | 'smooth'
                 */
                function scrollToBottom(behavior = "auto") {
                    // é˜²æŠ–å¤„ç†ï¼šé¿å…é¢‘ç¹æ»šåŠ¨å½±å“æ€§èƒ½
                    if (scrollTimer) {
                        clearTimeout(scrollTimer);
                    }

                    scrollTimer = setTimeout(() => {
                        nextTick(() => {
                            if (!chatMain.value) return;
                            const el = chatMain.value;
                            el.scrollTo({
                                top: el.scrollHeight,
                                behavior
                            });
                        });
                    }, behavior === "smooth" ? CONFIG.SCROLL_DEBOUNCE : 0);
                }

                /**
                 * å¯åŠ¨æ‰“å­—æœºæ•ˆæœ
                 * @param {Object} msg - æ¶ˆæ¯å¯¹è±¡
                 * @param {number} speed - æ‰“å­—é€Ÿåº¦ï¼ˆæ¯«ç§’/å­—ç¬¦ï¼‰
                 */
                function startTypewriter(msg, speed = CONFIG.TYPEWRITER_SPEED) {
                    // åˆå§‹åŒ– displayedContent
                    if (!msg.displayedContent) {
                        msg.displayedContent = "";
                    }

                    // å¦‚æœå·²ç»æœ‰å®šæ—¶å™¨åœ¨è¿è¡Œï¼Œä¸é‡å¤åˆ›å»º
                    if (typewriterTimers.has(msg)) {
                        return;
                    }

                    // ç«‹å³æ˜¾ç¤ºç¬¬ä¸€ä¸ªå­—ç¬¦ï¼ˆå¦‚æœæœ‰å†…å®¹ï¼‰
                    if (msg.content.length > 0 && msg.displayedContent.length === 0) {
                        msg.displayedContent = msg.content.substring(0, 1);
                        scrollToBottom("smooth");
                    }

                    // åˆ›å»ºå®šæ—¶å™¨ï¼Œé€ä¸ªå­—ç¬¦æ˜¾ç¤º
                    const timer = setInterval(() => {
                        if (msg.displayedContent.length < msg.content.length) {
                            // æ¯æ¬¡æ˜¾ç¤ºä¸€ä¸ªå­—ç¬¦
                            msg.displayedContent = msg.content.substring(0, msg.displayedContent.length + 1);
                            scrollToBottom("smooth");
                        } else if (!msg.isThinking) {
                            // æ€è€ƒç»“æŸä¸”å†…å®¹å·²å…¨éƒ¨æ˜¾ç¤ºï¼Œæ¸…é™¤å®šæ—¶å™¨
                            clearInterval(timer);
                            typewriterTimers.delete(msg);
                        }
                        // å¦‚æœè¿˜åœ¨æ€è€ƒä¸­ï¼Œç»§ç»­ç­‰å¾…æ–°å†…å®¹
                    }, speed);

                    typewriterTimers.set(msg, timer);
                }

                /**
                 * åœæ­¢æ‰“å­—æœºæ•ˆæœå¹¶ç¡®ä¿æ‰€æœ‰å†…å®¹æ˜¾ç¤º
                 * @param {Object} msg - æ¶ˆæ¯å¯¹è±¡
                 */
                function stopTypewriter(msg) {
                    if (typewriterTimers.has(msg)) {
                        clearInterval(typewriterTimers.get(msg));
                        typewriterTimers.delete(msg);
                    }
                    // ç¡®ä¿æ‰€æœ‰å†…å®¹éƒ½å·²æ˜¾ç¤º
                    if (msg.displayedContent.length < msg.content.length) {
                        msg.displayedContent = msg.content;
                    }
                }

                // ========== äº‹ä»¶å¤„ç†å‡½æ•° ==========
                function handleEnter() {
                    if (!input.value.trim()) return;
                    send();
                }

                /**
                 * åˆ‡æ¢å½“å‰ä¼šè¯
                 * @param {string} chatId - ä¼šè¯ ID
                 */
                async function setActiveChat(chatId) {
                    if (activeChatId.value === chatId) return;
                    activeChatId.value = chatId;

                    // å¦‚æœè¯¥ä¼šè¯æ¶ˆæ¯ä¸ºç©ºï¼Œå°è¯•åŠ è½½å†å²æ¶ˆæ¯
                    const chat = chats.value.find(c => c.id === chatId);
                    if (chat && chat.messages.length === 0) {
                        await loadThreadHistory(chat.threadId);
                    }

                    // åˆ‡æ¢ä¼šè¯åè‡ªåŠ¨æ»šåˆ°åº•éƒ¨
                    scrollToBottom("auto");
                }

                /**
                 * æ–°å»ºä¸€ä¸ªä¼šè¯ï¼ˆè°ƒç”¨åç«¯ APIï¼‰
                 */
                async function createNewChat() {
                    if (!ensureUserId()) return;

                    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç©ºä¼šè¯
                    if (hasEmptyChat.value) {
                        const emptyChat = chats.value.find(chat => chat.messages.length === 0);
                        if (emptyChat) {
                            // è‡ªåŠ¨åˆ‡æ¢åˆ°ç©ºä¼šè¯
                            activeChatId.value = emptyChat.id;
                            alert('å·²å­˜åœ¨ä¸€ä¸ªç©ºä¼šè¯ï¼Œæ— æ³•åˆ›å»ºæ–°ä¼šè¯ã€‚');
                            return;
                        }
                    }

                    try {
                        // è°ƒç”¨åç«¯åˆ›å»ºä¼šè¯
                        const response = await fetch(CONFIG.THREADS_API_URL, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                user_id: currentUserId.value,
                                title: `æ–°ä¼šè¯ ${chats.value.length + 1}`
                            })
                        });

                        if (!response.ok) {
                            throw new Error(`åˆ›å»ºä¼šè¯å¤±è´¥: ${response.statusText}`);
                        }

                        const data = await response.json();
                        const thread = data.thread;

                        // æ·»åŠ åˆ°æœ¬åœ°åˆ—è¡¨é¡¶éƒ¨
                        chats.value.unshift({
                            id: thread.id,
                            name: thread.title || `ä¼šè¯ ${thread.id.slice(0, 8)}`,
                            userId: thread.user_id,
                            threadId: thread.id,
                            preview: thread.preview || 'æš‚æ— æ¶ˆæ¯',
                            messages: []
                        });

                        activeChatId.value = thread.id;
                        input.value = "";
                        scrollToBottom("auto");
                    } catch (err) {
                        console.error('åˆ›å»ºä¼šè¯å¤±è´¥:', err);
                        alert('åˆ›å»ºä¼šè¯å¤±è´¥ï¼Œè¯·é‡è¯•');
                    }
                }

                /**
                 * å¤„ç†æµå¼å“åº”æ•°æ®
                 * @param {ReadableStreamDefaultReader} reader - æµè¯»å–å™¨
                 * @param {Object} assistantMsg - AI æ¶ˆæ¯å¯¹è±¡
                 */
                function handleStreamResponse(reader, assistantMsg) {
                    const decoder = new TextDecoder("utf-8");
                    let buffer = "";

                    function read() {
                        reader.read()
                            .then(({ done, value }) => {
                                if (done) {
                                    // æµç»“æŸ
                                    assistantMsg.isThinking = false;
                                    // ç¡®ä¿æ‰€æœ‰å†…å®¹éƒ½å·²æ˜¾ç¤º
                                    if (assistantMsg.displayedContent.length < assistantMsg.content.length) {
                                        startTypewriter(assistantMsg);
                                    }
                                    // å»¶è¿Ÿæ¸…ç†ï¼Œç¡®ä¿æ‰€æœ‰å†…å®¹éƒ½æ˜¾ç¤ºå®Œ
                                    setTimeout(() => {
                                        stopTypewriter(assistantMsg);
                                    }, CONFIG.TYPEWRITER_CLEANUP_DELAY);
                                    scrollToBottom("smooth");
                                    return;
                                }

                                // è§£ç å¹¶å¤„ç†æ•°æ®
                                buffer += decoder.decode(value, { stream: true });
                                const chunks = buffer.split("\n\n");
                                buffer = chunks.pop() || ""; // ä¿ç•™æœ€åä¸€ä¸ªä¸å®Œæ•´çš„ chunk

                                chunks.forEach(chunk => {
                                    parseSSEData(chunk, assistantMsg);
                                });

                                // ç»§ç»­è¯»å–
                                read();
                            })
                            .catch(err => {
                                handleError(err, assistantMsg, "è¯»å–æµå¤±è´¥");
                            });
                    }

                    read();
                }

                /**
                 * è§£æ SSE æ ¼å¼æ•°æ®
                 * @param {string} chunk - æ•°æ®å—
                 * @param {Object} assistantMsg - AI æ¶ˆæ¯å¯¹è±¡
                 */
                function parseSSEData(chunk, assistantMsg) {
                    const trimmed = chunk.trim();
                    if (!trimmed || !trimmed.startsWith("data: ")) return;

                    try {
                        const jsonStr = trimmed.replace("data: ", "");
                        const data = JSON.parse(jsonStr);

                        // data.type === "token"
                        if (data.content) {
                            // å»æ‰å¼€å¤´çš„æ¢è¡Œç¬¦
                            const content = data.content.replace(/^\n/, '');
                            assistantMsg.content += content;
                            // å¯åŠ¨æˆ–ç»§ç»­æ‰“å­—æœºæ•ˆæœ
                            if (!typewriterTimers.has(assistantMsg)) {
                                startTypewriter(assistantMsg);
                            }
                        }
                    } catch (e) {
                        console.error("è§£æ SSE æ•°æ®å¤±è´¥:", e, "åŸå§‹æ•°æ®:", trimmed);
                    }
                }

                /**
                 * ç»Ÿä¸€é”™è¯¯å¤„ç†
                 * @param {Error} err - é”™è¯¯å¯¹è±¡
                 * @param {Object} assistantMsg - AI æ¶ˆæ¯å¯¹è±¡
                 * @param {string} message - é”™è¯¯æ¶ˆæ¯
                 */
                function handleError(err, assistantMsg, message) {
                    console.error(message, err);
                    assistantMsg.isThinking = false;
                    stopTypewriter(assistantMsg);

                    // å¦‚æœè¿˜æ²¡æœ‰å†…å®¹ï¼Œæ˜¾ç¤ºé”™è¯¯æç¤º
                    if (!assistantMsg.content) {
                        assistantMsg.content = "æŠ±æ­‰ï¼Œå‘ç”Ÿäº†é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•ã€‚";
                        assistantMsg.displayedContent = assistantMsg.content;
                    }

                    scrollToBottom("smooth");
                }

                /**
                 * å¿«æ·å‘é€â€œä½ å¥½â€
                 */
                function sayHello() {
                    if (isThinking.value) return;
                    input.value = "ä½ å¥½";
                    send();
                }

                /**
                 * å‘é€æ¶ˆæ¯
                 */
                function send() {
                    const userMessage = input.value.trim();
                    if (!userMessage || isThinking.value) return;

                    if (!activeChat.value) {
                        console.warn("å½“å‰æ²¡æœ‰é€‰ä¸­çš„ä¼šè¯ï¼Œæ— æ³•å‘é€æ¶ˆæ¯");
                        return;
                    }
                    if (!ensureUserId()) return;

                    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
                    activeChat.value.messages.push({
                        role: "user",
                        content: userMessage
                    });
                    // å‘é€æ¶ˆæ¯åï¼Œè¯¥ä¼šè¯ä¸å†æ˜¯ç©ºä¼šè¯
                    activeChat.value.isEmptyFromServer = false;
                    input.value = "";
                    scrollToBottom();

                    // åˆ›å»º AI æ¶ˆæ¯å ä½ç¬¦ï¼ˆä½¿ç”¨ reactive ç¡®ä¿å“åº”å¼æ›´æ–°ï¼‰
                    const assistantMsg = reactive({
                        role: "assistant",
                        content: "",
                        displayedContent: "",
                        isThinking: true
                    });
                    activeChat.value.messages.push(assistantMsg);
                    scrollToBottom();

                    // å‘é€è¯·æ±‚
                    fetch(CONFIG.API_URL, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            user_id: currentUserId.value,
                            thread_id: activeChat.value.threadId,
                            message: userMessage
                        })
                    })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                            }
                            if (!response.body) {
                                throw new Error("å“åº”ä½“ä¸ºç©º");
                            }
                            return response.body.getReader();
                        })
                        .then(reader => {
                            handleStreamResponse(reader, assistantMsg);
                        })
                        .catch(err => {
                            handleError(err, assistantMsg, "è¯·æ±‚å¤±è´¥");
                        });
                }

                // ========== è¿”å›ç»™æ¨¡æ¿ä½¿ç”¨çš„æ•°æ®å’Œæ–¹æ³• ==========
                // ========== ç”Ÿå‘½å‘¨æœŸ ==========
                /**
                 * ä»åç«¯åŠ è½½ç”¨æˆ·çš„ä¼šè¯åˆ—è¡¨
                 */
                async function loadThreads() {
                    if (!currentUserId.value) return;

                    try {
                        const response = await fetch(`${CONFIG.THREADS_API_URL}/${encodeURIComponent(currentUserId.value)}?page=${page.value}&page_size=${pageSize.value}`);
                        if (!response.ok) {
                            console.error('åŠ è½½ä¼šè¯åˆ—è¡¨å¤±è´¥:', response.statusText);
                            return;
                        }

                        const data = await response.json();

                        // æ›´æ–°æ€»æ•°
                        if (data.total !== undefined) {
                            total.value = data.total;
                        }

                        if (data.threads && data.threads.length > 0) {
                            // æ¸…ç©ºç°æœ‰ä¼šè¯ï¼ŒåŠ è½½æŒä¹…åŒ–çš„ä¼šè¯
                            chats.value = data.threads.map((t, index) => ({
                                id: t.id,
                                name: t.title || `ä¼šè¯ ${t.id.slice(0, 8)}`,
                                userId: t.user_id,
                                threadId: t.id,
                                preview: t.preview || 'æš‚æ— æ¶ˆæ¯',
                                isEmptyFromServer: t.is_empty,  // ä½¿ç”¨åç«¯è¿”å›çš„ç©ºä¼šè¯çŠ¶æ€
                                messages: [] // æ¶ˆæ¯ç¨ååŠ è½½
                            }));

                            // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªä¼šè¯å¹¶åŠ è½½å…¶å†å²æ¶ˆæ¯
                            // ä»…å½“ activeChatId ä¸ºç©ºæˆ–è€…å½“å‰é€‰ä¸­çš„ä¼šè¯ä¸åœ¨åˆ—è¡¨ä¸­æ—¶ï¼Œæ‰åˆ‡æ¢
                            const currentChatStillExists = chats.value.find(c => c.id === activeChatId.value);
                            if (chats.value.length > 0 && !currentChatStillExists) {
                                activeChatId.value = chats.value[0].id;
                                await loadThreadHistory(chats.value[0].threadId);
                            }
                        } else if (page.value === 1) {
                            // æ²¡æœ‰å†å²ä¼šè¯ï¼Œè°ƒç”¨åç«¯åˆ›å»ºä¸€ä¸ªæ–°ä¼šè¯
                            await createNewChat();
                        }
                    } catch (err) {
                        console.error('åŠ è½½ä¼šè¯åˆ—è¡¨å‡ºé”™:', err);
                        // å‡ºé”™æ—¶ä¹Ÿå°è¯•åˆ›å»ºæ–°ä¼šè¯
                        await createNewChat();
                    }
                }

                /**
                 * åŠ è½½æŒ‡å®šä¼šè¯çš„å†å²æ¶ˆæ¯
                 */
                async function loadThreadHistory(threadId) {
                    if (!currentUserId.value || !threadId) return;

                    try {
                        const response = await fetch(
                            `${CONFIG.THREADS_API_URL}/${encodeURIComponent(currentUserId.value)}/${encodeURIComponent(threadId)}/history`
                        );
                        if (!response.ok) {
                            console.error('åŠ è½½å†å²æ¶ˆæ¯å¤±è´¥:', response.statusText);
                            return;
                        }

                        const data = await response.json();
                        const chat = chats.value.find(c => c.threadId === threadId);
                        if (chat && data.messages) {
                            // è½¬æ¢æ¶ˆæ¯æ ¼å¼å¹¶æ·»åŠ  displayedContent
                            chat.messages = data.messages.map(m => ({
                                role: m.role,
                                content: m.content,
                                displayedContent: m.content
                            }));

                            // æ›´æ–°é¢„è§ˆ
                            if (chat.messages.length > 0) {
                                const lastMsg = chat.messages[chat.messages.length - 1];
                                chat.preview = lastMsg.content.slice(0, 50) + (lastMsg.content.length > 50 ? '...' : '');
                            }

                            scrollToBottom('auto');
                        }
                    } catch (err) {
                        console.error('åŠ è½½å†å²æ¶ˆæ¯å‡ºé”™:', err);
                    }
                }



                /**
                 * åˆ é™¤ä¼šè¯
                 */
                async function deleteChat(chatId) {
                    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä¼šè¯å—ï¼Ÿ')) return;

                    try {
                        const response = await fetch(`${CONFIG.THREADS_API_URL}/${chatId}`, {
                            method: "DELETE"
                        });

                        if (!response.ok) {
                            throw new Error(`åˆ é™¤å¤±è´¥: ${response.statusText}`);
                        }

                        // ä»æœ¬åœ°åˆ—è¡¨ç§»é™¤
                        const index = chats.value.findIndex(c => c.id === chatId);
                        if (index > -1) {
                            chats.value.splice(index, 1);
                        }

                        // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰ä¼šè¯ï¼Œåˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ªæˆ–åˆ›å»ºæ–°ä¼šè¯
                        if (activeChatId.value === chatId) {
                            if (chats.value.length > 0) {
                                activeChatId.value = chats.value[0].id;
                                await loadThreadHistory(chats.value[0].threadId);
                            } else {
                                // æ‰€æœ‰ä¼šè¯éƒ½è¢«åˆ é™¤äº†ï¼Œåˆ›å»ºä¸€ä¸ªæ–°ä¼šè¯
                                await createNewChat();
                            }
                        }
                    } catch (err) {
                        console.error('åˆ é™¤ä¼šè¯å¤±è´¥:', err);
                        alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
                    }
                }

                async function prevPage() {
                    if (page.value > 1) {
                        page.value--;
                        await loadThreads();
                    }
                }

                async function nextPage() {
                    if (page.value * pageSize.value < total.value) {
                        page.value++;
                        await loadThreads();
                    }
                }

                onMounted(async () => {
                    const saved = localStorage.getItem("chatUserId");
                    if (saved) {
                        currentUserId.value = saved;
                        updateAllChatUserIds(saved);
                        // åŠ è½½æŒä¹…åŒ–çš„ä¼šè¯åˆ—è¡¨
                        await loadThreads();
                    } else {
                        openUserModal();
                    }
                });

                return {
                    // çŠ¶æ€
                    chats,
                    activeChatId,
                    activeChat,
                    messages,
                    input,
                    sayHello,
                    isThinking,
                    hasEmptyChat,
                    chatMain,
                    currentUserId,
                    isUserModalOpen,
                    tempUserInput,
                    // æ–¹æ³•
                    send,
                    handleEnter,
                    setActiveChat,
                    createNewChat,
                    openUserModal,
                    closeUserModal,
                    confirmUserId,
                    deleteChat,
                    isChatEmpty,
                    // åˆ†é¡µ
                    page,
                    pageSize,
                    total,
                    prevPage,
                    nextPage
                };
            }
        }).mount("#app");
    </script>
</body>

</html>